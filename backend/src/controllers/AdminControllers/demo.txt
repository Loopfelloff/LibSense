import type { Request, Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'
import { json } from 'node:stream/consumers'

interface AddAuthor {
    author_first_name: string
    author_middle_name?: string | null
    author_last_name: string
}

export const addAuthor = async (req: Request<{}, {}, AddAuthor>, res: Response) => {

    try {
        const { author_first_name, author_middle_name, author_last_name } = req.body

        if (!author_first_name || !author_last_name) {
            return res.status(400).json({ success: false, msg: 'First name and last name are required' })
        }

        const newAuthor = await prisma.bookAuthor.create({
            data: {
                author_first_name: author_first_name.trim(),
                author_middle_name: author_middle_name?.trim() ?? null,
                author_last_name: author_last_name.trim(),

            },
        })

        return res.status(201).json({ success: true, msg: 'Author added successfully', newAuthor })

    } catch (error: unknown) {
        console.error(error)

        if (error instanceof Error) {

            return res.status(500).json({
                success: false,
                errName: error.name,
                errMsg: error.message,
            })

        }
    }
}

import type { Request, Response } from "express"
import { prisma } from "../../config/prismaClientConfig.js"
import { uploadToCloudinary } from "../../config/cloudinaryConfig.js"

interface AddBookAuthor {
  author_id?: string
  first_name?: string
  middle_name?: string | null
  last_name?: string
}

interface AddBookBody {
  isbn: string
  book_title: string
  description?: string
  authors: AddBookAuthor[]
}

export const addBook = async (
  req: Request<{}, {}, AddBookBody>,
  res: Response
) => {
  try {
    const { isbn, book_title, description, authors } = req.body

    if (!isbn || !book_title || !Array.isArray(authors) || authors.length === 0) {
      return res.status(400).json({
        success: false,
        error: "ISBN, title and authors are required",
      })
    }

    let coverUrl: string = 'backend/src/resources/coverImageForBook.png'

    if (req.files) {
      const files = req.files as { [field: string]: Express.Multer.File[] }
      const file = files.book_cover_image?.[0]

      if (file) {
        const uploaded = await uploadToCloudinary(file.buffer, {
          folder: "Libsense/books",
          resource_type: "auto",
        })

        coverUrl = uploaded.secure_url
      }
    }

    const book = await prisma.book.create({
      data: {
        isbn: isbn.trim(),
        book_title: book_title.trim(),
        description: description?.trim() ?? "",
        book_cover_image: coverUrl,
      },
    })

    for (const author of authors) {
      let authorId: string

      if (author.author_id) {
        authorId = author.author_id
      } else {
        if (!author.first_name || !author.last_name) {
          return res.status(400).json({
            success: false,
            error: "First & last name required for new author",
          })
        }

        const newAuthor = await prisma.bookAuthor.create({
          data: {
            author_first_name: author.first_name.trim(),
            author_middle_name: author.middle_name?.trim() ?? null,
            author_last_name: author.last_name.trim(),
          },
        })

        authorId = newAuthor.id
      }

      await prisma.bookWrittenBy.create({
        data: {
          book_id: book.id,
          book_author_id: authorId,
        },
      })
    }

    const createdBook = await prisma.book.findUnique({
      where: { id: book.id },
      include: {
        book_written_by: {
          include: { book_author: true },
        },
      },
    })

    return res.status(201).json({
      success: true,
      book: createdBook,
    })
  } catch (error: unknown) {
    console.error("Error adding book:", error)

    if (error instanceof Error) {
      return res.status(500).json({
        success: false,
        errName: error.name,
        errMsg: error.message,
      })
    }

    return res.status(500).json({
      success: false,
      errName: "UnknownError",
    })
  }
}

import type { Request, Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'

export const deleteAuthor = async (req: Request<{ author_id: string }>, res: Response) => {
    try {
        const { author_id } = req.params

        const author = await prisma.bookAuthor.findUnique({
            where: { id: author_id },
        })

        if (!author) {
            return res.status(404).json({ success: false, msg: "Author not found" })
        }

        await prisma.bookAuthor.delete({
            where: { id: author_id },
        })

        return res.status(200).json({
            success: true,
            msg: "Author deleted successfully",
        })

    } catch (error: unknown) {
        console.error(error)

        if (error instanceof Error) {
            return res.status(500).json({
                success: false,
                errName: error.name,
                errMsg: error.message,
            })
        }

        return res.status(500).json({
            success: false,
            errName: "UnknownError",
        })
    }
}

import type {Request , Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'


export const deleteBook = async (req: Request<{ book_id: string }>, res: Response) => {
  try {
    const { book_id } = req.params

    const book = await prisma.book.findUnique({
      where: { id: book_id },
    })

    if (!book) {
      return res.status(404).json({ success: false, msg: "Book not found" })
    }

    await prisma.book.delete({
      where: { id: book_id },
    })

    return res.status(200).json({
      success: true,
      msg: "Book deleted successfully",
    })

  } catch (error: unknown) {
    console.error(error)

    if (error instanceof Error) {
      return res.status(500).json({
        success: false,
        errName: error.name,
        errMsg: error.message,
      })
    }

    return res.status(500).json({
      success: false,
      errName: "UnknownError",
    })
  }
}

import type {Request , Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'


export const getAuthorDetail = async (req: Request<{ author_id: string }>, res: Response) => {
  try {
    const { author_id } = req.params

    const author = await prisma.bookAuthor.findUnique({
      where: { id: author_id },
      select: {
        id: true,
        author_first_name: true,
        author_middle_name: true,
        author_last_name: true,
        book_written_by: {
          select: {
            book: {
              select: {
                id: true,
                book_title: true,
                isbn: true,
                book_cover_image: true,
                description: true,
              },
            },
          },
        },
      },
    })

    if (!author) {
      return res.status(404).json({ success: false, msg: "Author not found" })
    }

    const books = author.book_written_by.map((bw) => bw.book)

    return res.status(200).json({
      success: true,
      author: {
        id: author.id,
        first_name: author.author_first_name,
        middle_name: author.author_middle_name,
        last_name: author.author_last_name,
        books,
      },
    })
  } catch (error: unknown) {
    console.error(error)

    if (error instanceof Error) {
      return res.status(500).json({
        success: false,
        errName: error.name,
        errMsg: error.message,
      })
    }

    return res.status(500).json({
      success: false,
      errName: "UnknownError",
    })
  }
}

import type { Request, Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'


export const getBookDetail = async (req: Request<{ book_id: string }>, res: Response) => {
    try {
        const { book_id } = req.params


        const book = await prisma.book.findUnique({
            where: { id: book_id },
            select: {
                id: true,
                book_title: true,
                isbn: true,
                book_cover_image: true,
                description: true,
                book_written_by: {
                    select: {
                        book_author: {
                            select: {
                                id: true,
                                author_first_name: true,
                                author_middle_name: true,
                                author_last_name: true,
                            },
                        },
                    },
                },
            },
        })

        if (!book) {
            return res.status(404).json({ success: false, msg: "Book not found" })
        }

        const authors = book.book_written_by.map((bw) => bw.book_author)

        return res.status(200).json({
            success: true,
            book: {
                id: book.id,
                book_title: book.book_title,
                isbn: book.isbn,
                book_cover_image: book.book_cover_image,
                description: book.description,
                authors,
            },
        })
    } catch (error: unknown) {
        console.error(error)
        if (error instanceof Error) {
            return res.status(500).json({
                success: false,
                errName: error.name,
                errMsg: error.message,
            })
        }
        return res.status(500).json({ success: false, errName: "UnknownError" })
    }
}


import type { Request, Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'


export const getAllAuthors = async (req: Request, res: Response) => {
    try {

        const authors = await prisma.bookAuthor.findMany({
            select: {
                id: true,
                author_first_name: true,
                author_middle_name: true,
                author_last_name: true,
                book_written_by: {
                    select: {
                        book: {
                            select: {
                                id: true,
                                book_title: true,
                                isbn: true,
                                book_cover_image: true,
                                description: true,
                            },
                        },
                    },
                },
            },
            orderBy: {
                author_first_name: "asc",
            },
        })


        const formattedAuthors = authors.map((author) => ({
            id: author.id,
            first_name: author.author_first_name,
            middle_name: author.author_middle_name,
            last_name: author.author_last_name,
            books: author.book_written_by.map((bw) => bw.book),
        }))

        return res.status(200).json({ success: true, authors: formattedAuthors })
    } catch (error: unknown) {
        console.error(error)

        if (error instanceof Error) {
            return res.status(500).json({
                success: false,
                errName: error.name,
                errMsg: error.message,
            })
        }

        return res.status(500).json({ success: false, errName: "UnknownError" })
    }
}


import type { Request, Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'


export const getAllBooks = async (req: Request, res: Response) => {
    try {

        const books = await prisma.book.findMany({
            select: {
                id: true,
                book_title: true,
                isbn: true,
                book_cover_image: true,
                description: true,
                book_written_by: {
                    select: {
                        book_author: {
                            select: {
                                id: true,
                                author_first_name: true,
                                author_middle_name: true,
                                author_last_name: true,
                            },
                        },
                    },
                },
            },
            orderBy: {
                book_title: "asc",
            },
        })


        const formattedBooks = books.map((book) => ({
            id: book.id,
            book_title: book.book_title,
            isbn: book.isbn,
            book_cover_image: book.book_cover_image,
            description: book.description,
            authors: book.book_written_by.map((bw) => bw.book_author),
        }))

        return res.status(200).json({ success: true, books: formattedBooks })
    } catch (error: unknown) {
        console.error(error)

        if (error instanceof Error) {
            return res.status(500).json({
                success: false,
                errName: error.name,
                errMsg: error.message,
            })
        }

        return res.status(500).json({ success: false, errName: "UnknownError" })
    }
}


import type { Request, Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'


interface UpdateAuthorBody {
    author_id: string
    author_first_name?: string
    author_middle_name?: string | null
    author_last_name?: string
}


export const updateAuthor = async (
    req: Request<{}, {}, UpdateAuthorBody>,
    res: Response
) => {
    try {
        const { author_id, author_first_name, author_middle_name, author_last_name } = req.body

        const existingAuthor = await prisma.bookAuthor.findUnique({
            where: { id: author_id },
        })

        if (!existingAuthor) {
            return res.status(404).json({ success: false, msg: "Author not found" })
        }

        const updatedAuthor = await prisma.bookAuthor.update({
            where: { id: author_id },
            data: {
                author_first_name: author_first_name?.trim() ?? existingAuthor.author_first_name,
                author_middle_name:
                    author_middle_name !== undefined ? author_middle_name?.trim() ?? null : existingAuthor.author_middle_name,
                author_last_name: author_last_name?.trim() ?? existingAuthor.author_last_name,
            },
        })

        return res.status(200).json({ success: true, msg: "Author updated successfully", updatedAuthor })
    } catch (error: unknown) {
        console.error(error)

        if (error instanceof Error) {
            return res.status(500).json({
                success: false,
                errName: error.name,
                errMsg: error.message,
            })
        }

        return res.status(500).json({ success: false, errName: "UnknownError" })
    }
}


import type { Request, Response } from 'express'
import { prisma } from '../../config/prismaClientConfig.js'


interface BookAuthorInput {
    author_id?: string
    first_name?: string
    middle_name?: string | null
    last_name?: string
}

interface UpdateBookAuthorsBody {
    book_id: string
    authors: BookAuthorInput[]
}


export const updateBookAuthors = async (
    req: Request<{}, {}, UpdateBookAuthorsBody>,
    res: Response
) => {
    try {
        const { book_id, authors } = req.body

        if (!book_id || !Array.isArray(authors) || authors.length === 0) {
            return res.status(400).json({ success: false, msg: "Book ID and authors array are required" })
        }

        const existingBook = await prisma.book.findUnique({ where: { id: book_id } })
        if (!existingBook) {
            return res.status(404).json({ success: false, msg: "Book not found" })
        }

        for (const author of authors) {
            let authorId: string

            if (author.author_id) {
                authorId = author.author_id
            } else {
                if (!author.first_name || !author.last_name) {
                    return res.status(400).json({ success: false, msg: "New authors require first and last name" })
                }

                const newAuthor = await prisma.bookAuthor.create({
                    data: {
                        author_first_name: author.first_name.trim(),
                        author_middle_name: author.middle_name?.trim() ?? null,
                        author_last_name: author.last_name.trim(),
                    },
                })
                authorId = newAuthor.id
            }

            await prisma.bookWrittenBy.upsert({
                where: {
                    book_author_id_book_id: {
                        book_author_id: authorId,
                        book_id,
                    },
                },
                update: {},
                create: {
                    book_author_id: authorId,
                    book_id,
                },
            })

        }

        const updatedBook = await prisma.book.findUnique({
            where: { id: book_id },
            include: {
                book_written_by: {
                    include: { book_author: true },
                },
            },
        })

        return res.status(200).json({
            success: true,
            msg: "Book authors updated successfully",
            updatedBook,
        })
    } catch (error: unknown) {
        console.error(error)
        if (error instanceof Error) {
            return res.status(500).json({
                success: false,
                errName: error.name,
                errMsg: error.message,
            })
        }
        return res.status(500).json({ success: false, errName: "UnknownError" })
    }
}


import type { Request, Response } from "express"
import { prisma } from "../../config/prismaClientConfig.js"
import { uploadToCloudinary } from "../../config/cloudinaryConfig.js"

interface UpdateBookBody {
  book_id: string
  book_title?: string
  isbn?: string
  description?: string
}

export const updateBook = async (
  req: Request<{}, {}, UpdateBookBody>,
  res: Response
) => {
  try {
    const { book_id, book_title, isbn, description } = req.body

    const existingBook = await prisma.book.findUnique({
      where: { id: book_id },
    })

    if (!existingBook) {
      return res.status(404).json({
        success: false,
        msg: "Book not found",
      })
    }

    let coverUrl = existingBook.book_cover_image

    if (req.files) {
      const files = req.files as { [field: string]: Express.Multer.File[] }
      const file = files.book_cover_image?.[0]

      if (file) {
        const uploaded = await uploadToCloudinary(file.buffer, {
          folder: "Libsense/books",
          resource_type: "auto",
        })

        coverUrl = uploaded.secure_url
      }
    }

    const updatedBook = await prisma.book.update({
      where: { id: book_id },
      data: {
        book_title: book_title?.trim() ?? existingBook.book_title,
        isbn: isbn?.trim() ?? existingBook.isbn,
        description: description?.trim() ?? existingBook.description,
        book_cover_image: coverUrl,
      },
    })

    return res.status(200).json({
      success: true,
      msg: "Book updated successfully",
      updatedBook,
    })
  } catch (error: unknown) {
    console.error(error)

    if (error instanceof Error) {
      return res.status(500).json({
        success: false,
        errName: error.name,
        errMsg: error.message,
      })
    }

    return res.status(500).json({
      success: false,
      errName: "UnknownError",
    })
  }
}
